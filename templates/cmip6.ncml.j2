<?xml version="1.0" encoding="UTF-8"?>
{% set attrs = ['activity_id', 'Conventions', 'data_specs_version', 'experiment', 'experiment_id', 'forcing_index',
                'frequency', 'grid', 'grid_label', 'initialization_index', 'institution', 'institution_id', 'license',
                'mip_era', 'nominal_resolution', 'physics_index', 'product', 'realization_index', 'realm',
                'source', 'source_id', 'source_type', 'sub_experiment', 'sub_experiment_id', 'table_id',
                'variable_id', 'variant_label', 'cmor_version'] %}
{% set no_parent_attrs = ['branch_method', 'parent_activity_id', 'parent_experiment_id', 'parent_mip_era',
                          'parent_source_id', 'parent_time_units', 'parent_variant_label'] %}
{% set omit_attrs = ['branch_time_in_child', 'branch_time_in_parent'] %}
<netcdf xmlns="http://www.unidata.ucar.edu/namespaces/netcdf/ncml-2.2">
    <explicit/>

    <attribute name="__info__" value="Virtual dataset generated by the ESGF Virtual Aggregation Project (https://github.com/SantanderMetGroup/EVA)."/>
    <attribute name="__license__" value="This is a derived dataset product from ESGF, same licenses from original datasets apply for this dataset."/>
    <attribute name="__eva_version__" value="{{ eva_version }}"/>

    <attribute name="primary_variables" value="{{ (df[('GLOBALS', 'variable_id')].unique())|join(',') }}"/>
    <attribute name="size" type="int" value="{{ df[('GLOBALS', 'size')].sum()|int }}"/>
    <attribute name="size_human" value="{{ df[('GLOBALS', 'size')].sum()|filesizeformat }}"/>

    <!-- only mandatory (when required? = always) attributes from 
         http://cerfacs.fr/~coquart/data/uploads/cmip6_global_attributes_filenames_cvs_v6.2.6.pdf
         are included -->
    <!-- mandatory attributes are extracted from netcdf files
         BUT creation_date and further_info_url have got custom values relative to EVA -->
    {% for attr in attrs %}
    {% if ('GLOBALS', attr) in df.columns %}
    <attribute name="{{ attr }}" value="{{ (df[('GLOBALS', attr)].fillna("").iloc[0])|replace('\n', ' ') }}"/>
    {% else %}
    <attribute name="{{ attr }}" value=""/>
    {% endif %}
    {% endfor %}
    <!-- attributes that default to "no parent" if they don't exist -->
    {% for attr in no_parent_attrs %}
    {% if ('GLOBALS', attr) in df.columns and not (df[('GLOBALS', attr)].isna().all()) %}
    <attribute name="{{ attr }}" value="{{ (df[('GLOBALS', attr)].dropna().iloc[0])|replace('\n', ' ') }}"/>
    {% else %}
    <attribute name="{{ attr }}" value="no parent"/>
    {% endif %}
    {% endfor %}
    <!-- attributes that are omitted if they don't exist -->
    {% for attr in omit_attrs %}
    {% if ('GLOBALS', attr) in df.columns and not (df[('GLOBALS', attr)].isna().all()) %}
    <attribute name="{{ attr }}" value="{{ (df[('GLOBALS', attr)].dropna().iloc[0])|replace('\n', ' ') }}"/>
    {% endif %}
    {% endfor %}

    <attribute name="further_info_url" value="See netCDF variable 'further_info_url'"/>
    <attribute name="creation_date" value="{{ creation }}"/>
    <attribute name="version" value="v{{ df[('GLOBALS', 'version')].iloc[0] }}"/>
    <attribute name="replica" value="{{ df[('GLOBALS', 'replica')].iloc[0]|lower }}"/>

    <dimension name="nfiles" length="{{ df|length }}"/>
    {% if ('GLOBALS', 'further_info_url') in df.columns %}
    <variable name="further_info_url" type="string" shape="nfiles 2">
        <values>{{ (df[[('GLOBALS', 'OPENDAP'), ('GLOBALS', 'further_info_url')]].agg(' '.join, axis=1))|join(' ') }}</values>
    </variable>
    {% endif %}
    {% if ('GLOBALS', 'tracking_id') in df.columns %}
    <variable name="tracking_id" type="string" shape="nfiles 2">
        <values>{{ (df[[('GLOBALS', 'OPENDAP'), ('GLOBALS', 'tracking_id')]].fillna("").agg(' '.join, axis=1))|join(' ') }}</values>
    </variable>
    {% endif %}

    <dimension name="variant_label" length="{{ (df[('GLOBALS', 'variant_label')].dropna().unique())|length }}"/>
    <variable name="variant_label" shape="variant_label" type="string">
        <attribute name="standard_name" value="realization"/>
        <attribute name="_CoordinateAxisType" value="Ensemble"/>
    </variable>
    <aggregation type="joinNew" dimName="variant_label">
        {% for variable in df[('GLOBALS', 'variable_id')].unique() %}
        <variableAgg name="{{ variable }}"/>
        {% endfor %}
        {% for ensemble,ensemble_group in df.groupby(('GLOBALS', 'variant_label')) %}
        <netcdf coordValue="{{ ensemble }}">
            <aggregation type="union">
            {% for variable,variable_group in ensemble_group[ensemble_group[('GLOBALS', 'frequency')] != 'fx'].groupby(('GLOBALS', 'variable_id')) %}
                 <netcdf>
                     <aggregation type="joinExisting" dimName="time_{{ variable }}">
                         {% for _,i in variable_group.sort_values(by=[('GLOBALS', 'OPENDAP')]).iterrows() %}
                         <netcdf location="{{ i[('GLOBALS', 'OPENDAP')].rstrip('\n') }}" ncoords="{{ i[('_d_time', 'size')]|int }}">
                            <dimension name="time_{{ variable }}" orgName="time"/>
                            <variable name="time_{{ variable }}" orgName="time">
                                <attribute name="_CoordinateAxisType" value="Time"/>
                                <attribute name="units" value="{{ i[('time', 'units')] }}"/>
                                <attribute name="calendar" value="{{ i[('time', 'calendar')] }}"/>
                                {% if i[('GLOBALS', '_modified_time_coord')] %}
                                <values>{{ i[('time', '_values')]|join(' ') }}</values>
                                {% endif %}
                            </variable>
                            <variable name="{{ variable }}" shape="{{ i[(variable, '_dimensions')]|replace(',', ' ') }}">
                                {% if (variable, 'cell_methods') in i.index and i[(variable, 'cell_methods')] %}
                                <attribute name="cell_methods" value="{{ i[(variable, 'cell_methods')] }}"/>
                                {% endif %}
                                {% if (variable, 'coordinates') in i.index and i[(variable, 'coordinates')] %}
                                <attribute name="coordinates" value="{{ i[(variable, 'coordinates')]|replace(',', ' ') }}"/>
                                {% endif %}
                                <attribute name="_CoordinateAxes" value="{{ i[('GLOBALS', '_CoordinateAxes')]|replace(',', ' ') }}"/>
                            </variable>
                         </netcdf>
                         {% endfor %}
                     </aggregation>
                 </netcdf>
            {% endfor %}
            {% for _,fx in ensemble_group[ensemble_group[('GLOBALS', 'frequency')] == 'fx'].iterrows() %}
                <netcdf location="{{ fx[('GLOBALS', 'OPENDAP')].rstrip('\n') }}"/>
            {% endfor %}
            </aggregation>
        </netcdf>
        {% endfor %}
    </aggregation>
</netcdf>
